import{A as h,i as he,f as g,g as be,p as W,c as v,E as xe,l as S,a as U,b as e,u as A,I as G,k as E,t as d,G as H,H as fe,F as D,h as $,d as we,j as _e,o as m,a1 as Te}from"./index-B8b6vpke.js";import{L as Se,T as De}from"./Toast-S2wpvofn.js";import{l as ke}from"./lodash-BBt1jD-E.js";import{E as Me}from"./jspdf.es.min-BeEj7trP.js";const Pe={class:"h-screen w-full"},Ce={class:"bg-[#285a19] shadow p-4 flex justify-between items-center text-white"},Fe={class:"flex items-center space-x-4"},Ae={class:"relative inline-block text-left"},Ee={class:"flex items-center space-x-2"},$e=["src"],Le={key:0,class:"absolute right-0 z-50 mt-2 w-48 bg-white rounded shadow-lg"},Ie={class:"container mx-auto p-4"},Ne={class:"flex flex-wrap items-center justify-between gap-4 mb-4"},Re={class:"flex flex-wrap items-center gap-4"},Ve=["disabled"],Ue={class:"text-sm sm:text-base font-semibold"},qe={key:0,class:"text-sm sm:text-base font-semibold"},je={class:"mb-3 space-y-3"},Oe={class:"flex items-center space-x-2"},Ye={class:"overflow-x-auto"},Be={class:"max-h-[400px] overflow-y-auto"},ze={class:"w-full border-collapse border border-gray-300 rounded-md min-w-[600px]"},We={key:0,class:"text-center"},Ge={colspan:"4",class:"px-3 sm:px-4 py-2 text-xs sm:text-sm"},He={class:"px-3 sm:px-4 py-2"},Je={class:"px-3 sm:px-4 py-2"},Ke={class:"px-3 sm:px-4 py-2"},Qe={class:"text-blue-500"},Xe={class:"px-3 sm:px-4 py-2"},Ze={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"},et={class:"bg-white p-6 rounded-lg w-full max-w-md"},tt={class:"grid grid-cols-1 gap-6"},st={class:"text-xs text-green-600"},at={class:"flex justify-between items-center my-2"},ot={class:"font-medium"},lt={class:"mb-2"},nt={class:"grid grid-cols-7 text-center text-xs"},it={class:"grid grid-cols-7 gap-1 text-center text-xs"},rt=["onClick"],ut={class:"space-y-2"},ct={class:"flex items-center"},dt=["value","disabled"],mt={class:"text-sm"},pt={class:"flex justify-between mt-6"},vt=["disabled"],w=3e3,ft={__name:"Payments",setup(yt){const l=he(),J=_e(),K=h(()=>l.state.showLoading.state),k=h(()=>{var a;return((a=l.state.userData.data)==null?void 0:a.user)||{}}),M=h(()=>l.state.User.payment.data),L=g(!1),I=g(!1),r=g(null),y=g(null),_=g(!1),N=g(null),x=g(null),b=g(""),Q=a=>{if(!a)return null;const s=/^(\d{2})\/(\d{2})\/(\d{4})$/,t=a.match(s);if(t){const[,u,n,o]=t,i=`${o}-${u.padStart(2,"0")}-${n.padStart(2,"0")}`,c=new Date(i);if(c.getFullYear()===parseInt(o)&&c.getMonth()+1===parseInt(u)&&c.getDate()===parseInt(n))return i}return console.warn(`Invalid date format: ${a}`),null},q=h(()=>b.value?(M.value||[]).filter(a=>Q(a.date)===b.value):M.value||[]),j=ke.debounce(()=>{},300),X=()=>{b.value=""},T=h(()=>{var a;return((a=N.value)==null?void 0:a.totalSales)||"0.00"}),R=async()=>{await Z(),await Y(),await ee()};async function Z(){try{await l.dispatch("User/getPayMent")}catch(a){console.error("Failed to fetch payment list:",a)}}async function ee(){try{const t=((await l.dispatch("User/getPendingPayments")).data||[]).find(u=>u.account_id===k.value.id);if(t)x.value={date:t.date,time_slot:t.time_slot,status:t.status};else{const o=((await l.dispatch("User/getApprovedPayments")).data||[]).find(i=>i.account_id===k.value.id);x.value=o?{date:o.date,time_slot:o.time_slot,status:o.status}:null}}catch(a){console.error("Failed to fetch payout schedule:",a),x.value=null}}be(()=>{R()}),h(()=>M.value&&M.value.length>0);const te=["Su","Mo","Tu","We","Th","Fr","Sa"],p=g(new Date(2025,4,1)),se=h(()=>p.value.toLocaleString("default",{month:"long"})),ae=h(()=>p.value.getFullYear()),oe=h(()=>{const a=new Date,s=new Date(a);for(s.setDate(a.getDate()+1);!V(s);)s.setDate(s.getDate()+1);return s.toLocaleDateString("en-US",{day:"numeric",month:"long",year:"numeric"})}),P=g([]),le=h(()=>{var i;const a=p.value.getFullYear(),s=p.value.getMonth(),t=new Date(a,s,1).getDay(),u=new Date(a,s+1,0).getDate(),n=new Date,o=[];for(let c=0;c<t;c++)o.push({day:"",isEmpty:!0});for(let c=1;c<=u;c++){const f=new Date(a,s,c),z=f<new Date(n.getFullYear(),n.getMonth(),n.getDate()),ye=!z&&V(f)&&(((i=C.value[f.toISOString().split("T")[0]])==null?void 0:i.totalAvailable)||0)>0,ge=r.value&&f.getDate()===r.value.getDate()&&f.getMonth()===r.value.getMonth()&&f.getFullYear()===r.value.getFullYear();o.push({day:c,date:f,isAvailable:ye,isSelected:ge,isPast:z,isEmpty:!1})}return o}),C=g({}),ne=()=>{p.value=new Date(p.value.getFullYear(),p.value.getMonth()-1,1),r.value=null,y.value=null,F()},ie=()=>{p.value=new Date(p.value.getFullYear(),p.value.getMonth()+1,1),r.value=null,y.value=null,F()},re=a=>{a.isEmpty||a.isPast||!a.isAvailable||(r.value=a.date,y.value=null,O())},V=a=>{const s=a.getDay();return s!==0&&s!==6},O=()=>{var t;if(!r.value){P.value=[];return}const a=r.value.toISOString().split("T")[0],s=((t=C.value[a])==null?void 0:t.slots)||[];P.value=["10:00-11:00","11:00-12:00","12:00-13:00","13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00"].map(u=>{const n=s.find(o=>o.time_slot===u)||{};return{time:u,isAvailable:n.is_available||!1,availableSlots:n.available_slots||null}})},F=async()=>{const a=p.value.getFullYear(),s=p.value.getMonth(),t=new Date(a,s,1).toISOString().split("T")[0],u=new Date(a,s+1,0).toISOString().split("T")[0];try{const n=await l.dispatch("User/getSlots",{date:`${t}/${u}`}),o={};n.forEach(i=>{const c=i.date;o[c]||(o[c]={slots:[],totalAvailable:0}),o[c].slots.push(i),i.is_available&&(o[c].totalAvailable+=i.available_slots||1)}),C.value=o}catch(n){console.error("Failed to fetch slots:",n)}};W(r,()=>{r.value&&O()}),W(p,()=>{F()});const ue=async()=>{try{l.dispatch("toggleLoader",!0);const s=await(await l.dispatch("User/getCSV")).text();try{const t=JSON.parse(s);if(!t.isSuccess)throw new Error(t.message||"Failed to export CSV")}catch(t){if(t.message&&t.message!=="Failed to export CSV"){const u=new Blob([s],{type:"text/csv;charset=utf-8"}),n=window.URL.createObjectURL(u),o=document.createElement("a");o.href=n,o.setAttribute("download",`payment_history_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(n),l.commit("showToast",{showToast:!0,toastMessage:"CSV exported successfully",toastType:"success"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w)}else throw t}}catch(a){a.message!=="No payment history found."&&console.error("Export CSV error:",a),l.commit("showToast",{showToast:!0,toastMessage:a.message||"Failed to export CSV",toastType:"error"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w)}finally{l.dispatch("toggleLoader",!1)}},Y=async()=>{try{const a=await l.dispatch("User/checkPayoutEligibility");N.value=a,_.value=a.eligible}catch(a){console.error("Eligibility check failed:",a),N.value=null,_.value=!1}},ce=async()=>{await Y(),_.value?(I.value=!0,F()):(l.commit("showToast",{showToast:!0,toastMessage:`You are not eligible for a payout. Total sales (₱${T.value}) must be at least ₱500 or you have a pending payout request.`,toastType:"error"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w))},B=()=>{r.value=null,y.value=null,I.value=!1,C.value={},P.value=[]},de=()=>["apple","banana","cherry","date","elderberry","fig","grape","honeydew","kiwi","lemon","mango","nectarine","orange","papaya","quince","raspberry","strawberry","tangerine","ugli","watermelon"].sort(()=>.5-Math.random()).slice(0,10).join("-"),me=async()=>{if(!r.value||!y.value){l.commit("showToast",{showToast:!0,toastMessage:"Please select a date and time",toastType:"error"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w);return}if(!_.value||parseFloat(T.value)<500){l.commit("showToast",{showToast:!0,toastMessage:`You are not eligible for a payout. Total sales (₱${T.value}) must be at least ₱500.`,toastType:"error"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w);return}l.dispatch("toggleLoader",!0);const a=r.value.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s=r.value.toISOString().split("T")[0],t=de(),u={date:s,time_slot:y.value,total_sales:parseFloat(T.value),validation_code:t};try{const n=await l.dispatch("User/requestPayout",u);if(!n.isSuccess)throw new Error(n.message||"Failed to request payout");const o={sellerName:k.value.name||"N/A",date:a,time:y.value,totalSales:`₱${T.value}`,appointmentType:"Payout Request",validationCode:t,queueNumber:n.payout.queue_number},i=new Me;i.setFontSize(16),i.text("Schedule Slip",20,20),i.setFontSize(12),i.text(`Seller: ${o.sellerName}`,20,40),i.text(`Date: ${o.date}`,20,50),i.text(`Time: ${o.time}`,20,60),i.text(`Total Sales: ${o.totalSales}`,20,70),i.text(`Appointment Type: ${o.appointmentType}`,20,80),i.text(`Validation Code: ${o.validationCode}`,20,90),i.text(`Queue Number: ${o.queueNumber}`,20,100);const c=`schedule-slip-${s}.pdf`;i.save(c),l.commit("showToast",{showToast:!0,toastMessage:"Payout request submitted and schedule slip downloaded",toastType:"success"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w),B(),await R()}catch(n){console.error("Payout request failed:",n),l.commit("showToast",{showToast:!0,toastMessage:n.message||"Failed to request payout. Please try again.",toastType:"error"}),setTimeout(()=>{l.commit("showToast",{showToast:!1,toastMessage:"",toastType:"default"})},w)}finally{l.dispatch("toggleLoader",!1)}},pe=()=>{L.value=!L.value},ve=async()=>{try{(await l.dispatch("logout")).isSuccess&&J.push({name:"Login"})}catch(a){console.error("Logout error:",a)}};return(a,s)=>(m(),v(D,null,[K.value?(m(),xe(Se,{key:0,class:"loading"})):S("",!0),U(De),e("div",Pe,[e("header",Ce,[s[4]||(s[4]=e("h1",{class:"text-lg sm:text-xl 2xl:ml-0 md:ml-10 2xs:ml-10 font-bold"},"Payment Transaction",-1)),e("div",Fe,[e("div",Ae,[e("div",Ee,[e("img",{src:k.value.avatar,alt:"Profile",class:"w-10 h-10 rounded-full object-cover shadow-md"},null,8,$e),U(A(G),{icon:"uil:setting",width:"24",height:"24",class:"cursor-pointer text-white",onClick:pe})]),L.value?(m(),v("div",Le,[s[3]||(s[3]=e("a",{href:"/seller-profile",class:"block px-4 py-2 text-sm text-black hover:bg-gray-100"}," Account Info ",-1)),e("button",{onClick:ve,class:"block w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100"}," Logout ")])):S("",!0)])])]),e("div",Ie,[e("div",Ne,[e("div",Re,[e("button",{onClick:R,class:"bg-[#608C54] py-2 px-4 sm:px-6 text-white rounded-md flex items-center gap-1 hover:bg-gray-700 transition"},[U(A(G),{icon:"material-symbols-light:refresh",width:"20",height:"20"}),s[5]||(s[5]=e("span",{class:"hidden sm:inline"},"Refresh",-1))]),e("button",{onClick:ue,class:"bg-gray-300 py-2 px-4 rounded-md text-sm sm:text-base hover:bg-gray-400 transition"}," Export to CSV "),e("button",{onClick:ce,disabled:!_.value,class:E(["bg-[#285a19] py-2 px-4 rounded-md text-sm sm:text-base text-white hover:bg-gray-700 transition",{"bg-gray-300 cursor-not-allowed":!_.value}])}," Request a Payout ",10,Ve),e("div",Ue,"Total Sales: ₱"+d(T.value),1)]),x.value?(m(),v("div",qe,[s[6]||(s[6]=e("div",null,"Payout Schedule:",-1)),e("div",null,"Date: "+d(x.value.date),1),e("div",null,"Time: "+d(x.value.time_slot),1),e("div",null,"Status: "+d(x.value.status),1)])):S("",!0)]),e("div",je,[s[8]||(s[8]=e("p",{class:"text-xs sm:text-sm md:text-base"},"View the payment history here. It might take some time for payments to appear in the portal.",-1)),e("div",Oe,[s[7]||(s[7]=e("label",{for:"payment-date-filter",class:"text-sm font-semibold"},"Filter by Date:",-1)),H(e("input",{id:"payment-date-filter","onUpdate:modelValue":s[0]||(s[0]=t=>b.value=t),type:"date",class:"p-2 border rounded-md text-sm",onInput:s[1]||(s[1]=(...t)=>A(j)&&A(j)(...t))},null,544),[[fe,b.value]]),b.value?(m(),v("button",{key:0,onClick:X,class:"px-3 py-1 bg-gray-300 text-sm rounded-md hover:bg-gray-400"}," Clear ")):S("",!0)])]),e("div",Ye,[e("div",Be,[e("table",ze,[s[9]||(s[9]=e("thead",{class:"sticky top-0 bg-gray-300 z-10"},[e("tr",{class:"text-xs sm:text-sm md:text-md"},[e("th",{class:"px-3 sm:px-4 py-2 text-left border-b border-gray-300"},"Date"),e("th",{class:"px-3 sm:px-4 py-2 text-left border-b border-gray-300"},"Product Name"),e("th",{class:"px-3 sm:px-4 py-2 text-left border-b border-gray-300"},"Payment Method"),e("th",{class:"px-3 sm:px-4 py-2 text-left border-b border-gray-300"},"Amount")])],-1)),e("tbody",null,[q.value.length?(m(!0),v(D,{key:1},$(q.value,t=>(m(),v("tr",{key:t.id,class:"border-b border-gray-200 hover:bg-gray-200 text-xs sm:text-sm"},[e("td",He,d(t.date),1),e("td",Je,d(t.product_name),1),e("td",Ke,[e("span",Qe,d(t.payment_method),1)]),e("td",Xe,"₱"+d(t.amount),1)]))),128)):(m(),v("tr",We,[e("td",Ge,d(b.value?`No transactions found for ${b.value}`:"No transactions found."),1)]))])])])])]),I.value?(m(),v("div",Ze,[e("div",et,[s[14]||(s[14]=e("h2",{class:"text-lg font-bold mb-4"},"Request a Payout",-1)),e("div",tt,[e("div",null,[s[10]||(s[10]=e("div",{class:"text-sm font-medium"},"Date",-1)),e("div",st,"Earliest available appointment: "+d(oe.value),1),s[11]||(s[11]=e("div",{class:"text-xs text-red-500"},"To the extent possible, additional slots are made regularly.",-1)),e("div",at,[e("button",{onClick:ne,class:"text-blue-500 font-bold"},"«"),e("span",ot,d(se.value)+" "+d(ae.value),1),e("button",{onClick:ie,class:"text-blue-500 font-bold"},"»")]),e("div",lt,[e("div",nt,[(m(),v(D,null,$(te,t=>e("div",{key:t,class:"py-1"},d(t.substring(0,2)),1)),64))]),e("div",it,[(m(!0),v(D,null,$(le.value,t=>(m(),v("div",{key:t.day+t.isEmpty,class:E(["py-1 px-1",t.isEmpty?"text-gray-300":"cursor-pointer",t.isSelected?"bg-blue-500 text-white":"",!t.isEmpty&&!t.isSelected?t.isAvailable?"bg-green-100":"bg-red-100":""]),onClick:u=>t.isEmpty||!t.isAvailable||t.isPast||!V(t.date)?null:re(t)},d(t.day),11,rt))),128))])]),s[12]||(s[12]=we('<div class="flex gap-4 mt-1 text-xs"><div class="flex items-center"><span class="w-4 h-4 bg-green-100 inline-block mr-1"></span> Available </div><div class="flex items-center"><span class="w-4 h-4 bg-red-100 inline-block mr-1"></span> Fully Booked </div></div>',1))]),e("div",null,[s[13]||(s[13]=e("div",{class:"text-sm font-medium mb-2"},"Time",-1)),e("div",ut,[(m(!0),v(D,null,$(P.value,(t,u)=>(m(),v("div",{key:u,class:"flex justify-between items-center"},[e("label",ct,[H(e("input",{type:"radio",value:t.time,"onUpdate:modelValue":s[2]||(s[2]=n=>y.value=n),class:"mr-2",disabled:!t.isAvailable||!r.value},null,8,dt),[[Te,y.value]]),e("span",mt,d(t.time),1)]),e("span",{class:E([{"text-green-600":t.isAvailable&&r.value,"text-red-500":!t.isAvailable&&r.value,"text-gray-400":!r.value},"text-sm"])},d(t.isAvailable&&r.value?t.availableSlots?`Available Slots: ${t.availableSlots}`:"Available":r.value?"Fully Booked":""),3)]))),128))])])]),e("div",pt,[e("button",{onClick:B,class:"bg-blue-500 hover:bg-blue-600 text-white py-2 px-8 rounded"}," BACK "),e("button",{onClick:me,disabled:!r.value||!y.value,class:E(["py-2 px-8 rounded text-white",!r.value||!y.value?"bg-gray-300":"bg-blue-500 hover:bg-blue-600"])}," CONFIRM ",10,vt)])])])):S("",!0)])],64))}};export{ft as default};
